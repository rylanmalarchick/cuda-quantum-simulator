name: Build and Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  # CUDA toolkit path - adjust if installed elsewhere
  CUDA_HOME: /usr/local/cuda
  PATH: /usr/local/cuda/bin:$PATH
  LD_LIBRARY_PATH: /usr/local/cuda/lib64:$LD_LIBRARY_PATH

jobs:
  build-and-test:
    runs-on: [self-hosted, gpu, cuda]
    # Requires self-hosted runner with NVIDIA GPU and CUDA toolkit
    # Setup: https://docs.github.com/en/actions/hosting-your-own-runners

    steps:
    - uses: actions/checkout@v4

    - name: Setup CUDA environment
      run: |
        echo "Adding CUDA to PATH"
        echo "/usr/local/cuda/bin" >> $GITHUB_PATH
        echo "LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "CUDA_HOME=/usr/local/cuda" >> $GITHUB_ENV

    - name: Check CUDA availability
      run: |
        nvidia-smi
        nvcc --version

    - name: Configure CMake
      run: |
        mkdir -p build
        cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: |
        cd build
        make -j$(nproc)

    - name: Run Tests
      run: |
        cd build
        ctest --output-on-failure

    - name: Run Demo
      run: |
        cd build
        ./quantum_sim

  # Run benchmarks on main branch merges only (benchmarks can be slow)
  benchmark:
    runs-on: [self-hosted, gpu, cuda]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: build-and-test

    steps:
    - uses: actions/checkout@v4

    - name: Setup CUDA environment
      run: |
        echo "/usr/local/cuda/bin" >> $GITHUB_PATH
        echo "LD_LIBRARY_PATH=/usr/local/cuda/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV
        echo "CUDA_HOME=/usr/local/cuda" >> $GITHUB_ENV

    - name: Build
      run: |
        mkdir -p build && cd build
        cmake .. -DCMAKE_BUILD_TYPE=Release
        make -j$(nproc)

    - name: Run Gate Benchmark
      run: |
        cd build
        ./benchmark_gates

    - name: Run Scaling Benchmark
      run: |
        cd build
        ./benchmark_scaling

    - name: Run Kernel Launch Overhead Benchmark
      run: |
        cd build
        ./benchmark_hadamard
